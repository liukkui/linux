
网络协议和管理

    网络概念：
    OSI模型：  
    网络设备：
    TCP/IP: -TCP&UDP区别 -TCP首部 -TCP的三次握手和四次挥手 
    配置网络
    实现网路组
    测试网络
    网络工具


网际层协议：包括：IP协议、ICMP协议、ARP协议、RARP协议.
传输层协议：TCP协议、UDP协议.
应用层协议：FTP、Telnet、SMTP、HTTP、RIP、NFS、DNS等.

1.网络概念：

    位和字节的区别，1Gbps、100Mbps都是以位为单位的，10M/s是以字节为单位的
    网络拓扑等
2.OSI模型：


七层模型：
application、persention、session、transport、network、data-link、physical

    7.应用层： 提供各种程序的界面，浏览器，通信软件等 
    6.表示层： 数据的表达：ascii,utf-8,加密解密，压缩解压缩等
    5.会话层： 建立、管理主机之间的会话
    4.传输层： 数据报文格式：单位：段segent，建立终端到终端的通信-保证数据可靠性传输-tcp协议等
    3.网络层: 单位：包、报文package,记录逻辑地址：ip，路由、等-支持逻辑寻址、数据传输的路径选择
    2.数据链路层： 单位：帧,将物理层传上来的0,1进行组合并格式化组成 -帧frame-记录目标地址和源地址 (物理地址：mac)-检查数据报文的错误等. -链路间的通信
    1.物理层： 单位：比特bit,将各种网络设备进行物理层的确保按规范进行链接保证正常通讯,即只要0和1. -形成比特流


    通信过程
    a.发送端进行封装、接收端进行解封装、
      层层封装：数据+应用层报头+TCP/UDP报头+IP报头+帧头部=物理层的0101
    b.解封装的过程：
      下层协议为上层协议提供服务：因为上层有各种协议，所以在向上传递时，会有标记来体现出上层协议的类型
      层层解封装：物理层的0101=数据+应用层报头+TCP/UDP报头+IP报头+帧头部 
      所谓的丢包：是指发生在网络层
    c.数据位bit、数据帧frame、数据包packet、数据段segent、其它层都是message -都统称为PDU-协议数据单元是指对等层次之间传递的数据单位


三种通讯方式：

    单播：unicast
       目标发送报文时，目标地址是网络中的一个设备，称为单播
    广播：broadcast
        目标发送报文时，目标地址是一定范围内网络中的所有设备，称为广播
    组播：multicast
        目标发送报文时，目标地址是网络中的部分主机设备，称为多播或组播

局域网：LAN：Local Area Netwoek 本地区域网络 -基础广播机制进行通讯
广域网：wan：Wdie  Area Netwoek -基于点对点进行通讯

非屏蔽式双绞线-UTP

    T568B：橙白 橙 绿白 蓝 蓝白 绿白 棕白 棕 -最大程度上抵消彼此的电磁干扰
          低于100M时，一般用12/36两组 高于100M时，一般同种颜色的绞合在一起-直连线
    T568A
          单独两台电脑直连时用T568A
          100M以内时，1 2 TX+接收 3 6 RX+发送 13、26对调既可 一边按T568B做，一边按T568A做叫交叉线
          新设备自动识别直连线或者交叉线


单工：单向传输 -百兆以内
半双工：一个时间只能单向传输
全双工：可以同时传输和接收 -千兆以上-单模（激光）-多模光纤


以太网： -工作在数据链路层
   不仅仅可以把网络连接起来，还规定了数据帧的报文结构
   有限以太网和无线以太网wifi

-----------------------------------------------------------------------------------
-----------------------------------------------------------------------------------

数据链路层协议之以太网帧结构

以太网帧结构：固定长度是(8+6+6+2=22)
   
    Preamble Destination  Source  Type   Data   FCS

    前导信息  目标地址      源地址  type   Data    FCS

字节：  8         6           6      2   46-1500   4

1.前导信息：网卡传输时，标记以太网帧的开始
2.FCS:校验位，如果数据错误，网卡会把数据直接扔掉
3.以太网帧的最长长度：72-1526字节
  除去前导信息和FCS则是用户关心的有效信息：60-1514字节 -即各种抓包软件抓取的有效字节数

Destination:6个字节，48位，2^48个物理地址（mac）
Source:6个字节，48位，2^48个物理地址（mac）
Type：体现上层协议的类型
Data:包含上层网络层、传输层、应用层的头部信息+data数据信息

抓包：wireshark，指定要抓的网卡
tcpdump -i eth0 -nn -X  -指定网卡显示数字二进制信息 捕获到达该网卡的所有数据包


CSMA/CD 冲突检测的载波侦听多路访问
冲突域：一个主机发送报文，另一主机也发送报文，产生冲突，两个主机在一个冲突域
广播域：一个主机发送广播，另一主机收到，两个主机在一个广播域  -广播泛洪
网桥/交换机能隔断冲突域但不能隔断广播域

网桥/以太网桥的工作原理

    1.具有转发功能，所有不能隔断广播域
    2.交换机有镜像端口
    3.主机都连到交换机的一个端口，有效隔断冲突域
    4.网桥和交换机内部有写在内存中
        交换机/网桥会读取数据报文中的源地址和目标地址，而交换机有具有学习功能
        则将数据报文中的源地址mac -内存中记录接口和MAC的对应关系
    而记录在内存中的是主机的mac地址，而不是广播地址，因为广播地址的mac地址表现为6*8-48个1，不会存在内存表中
      a. a->b 进行通讯，则内存中会记录macA和B与对应的交换机端口，第二次通讯则不会影响其他主机
      b. 所以如果A发一个广播，广播的mac地址则不会存在交换机内存中，其他主机都能收到，即广播泛洪

路由器： -网络层的设备

    vlan：
    trunk协议:
        多个交换机是通过trunk干线相连，而trunk干线不属于任何vlan，属于公共干线
        不同vlan的主机如果要通讯，在通过trunk干线的瞬间，修改数据报文结构，在标准的以太网帧内加上一段记录vlan信息的数据，传给下一个交换机.
  

-----------------------------------------------------------------------------------
-----------------------------------------------------------------------------------

Internet/网络层协议：

    IP协议，ICMP协议，ARP协议，RARP协议

    ICMP协议：ping命令
         属于网络层的子层，建立在网络层之上
    作用：检查网络是否正常，根据网络状态提示，可以发现网络出现了什么问题
         type 8表示请求报文，type 0 表示回应报文
         配置安全策略的时候，可以根据type类型，判断是ping出去的包还是回应包
         可以配置 cat /proc/sys/net/ipv4/icmp_echo_ignore_all -0不忽略 -1忽略 关闭ping的回应报文


ARP协议

    Address Resolution Protocol:地址解析协议
    基于广播机制
    将IP地址解析成MAC地址，保存到arp缓存表中
    作用：通过广播机制，第一次通讯时，将IP发出去，如果该IP存在，则会把MAC地址响应该广播
        然后在每台主机的arp缓存表中,记录对方的IP和MAC地址，以备下次再通讯 
    arp -n 可以查看ARP缓存表中的信息

特殊arp:免费arp 每次开机前都会广播查询该IP是否有其他主机正在使用，避免IP冲突

安全隐患：冒充ARP广播的IP地址，所以一般https加密.

arping -I eth0  192.168.34.100 可以通过响应的mac地址个数来判断地址是否冲突

跨路由的ARP实现机制：
  a.需要配置网关 
  b.不在一个网段时，Arp广播找不到对方地址，则会找该网段的网关MAC，通过网关广播出去，知道找到对方IP

RARP:反向arp
  作用：先将IP和MAC地址进行绑定，当主机开机时，会通过广播把自己的MAC地址发送出去，然后获得服务器上已绑定的IP.


IP协议

IP报头：
    0             8          |                          31 32位，4字节
 
4     版本|首部长度|区分服务      总长度(包括数据在内的IP报文总长)

4               标识                   标志|片偏移    

4          生存时间|协议               首部检验和   

4                         源地址

4                        目标地址

4      可选字段(长度可变)                   填充

                          数据部分


版本:占4位,指 IP 协议的版本目前的IP协议版本号为4

首部长度:占4位,可表示的最大数值是15个单位，一个单位为4字节，因此IP的首部长度的最大值是60字节

区分服务:占8位,用来获得更好的服务,在旧标准中叫做服务类型,但实际上一直未被使用过.后改名为区分服务.只有在使用区分服务(DiffServ)时,这个字段才起作用.

总长度:占16位,指首部和数据之和的长度,单位为字节,因此数据报的最大长度为65535字节.总长度必须不超过最大传送单元 MTU
标识:占16位,它是一个计数器,通常，每发送一个报文，该值会加1，也用于数据包分片，在同一个包的若干分片中，该值是相同的 

标志(flag):占3位,目前只有后两位有意义
   DF： Don’t Fragment 中间的一位，只有当 DF=0 时才允许分片
   MF： More Fragment 最后一位，MF=1表示后面还有分片,MF=0 表示最后一个分片
片偏移:占12位,指较长的分组在分片后，该分片在原分组中的相对位置.片偏移以8个字节为偏移单位

生存时间:占8位,记为TTL (Time To Live) 数据报在网络中可通过的路由器数的最大值,TTL 字段是由发送端初始设置一个 8 bit字段.推荐的初始值由分配数字
RFC 指定,当前值为 64.发送 ICMP 回显应答时经常把 TTL 设为最大值 255

协议:占8位,指出此数据报携带的数据使用何种协议以便目的主机的IP层将数据，上层协议TCP-6/UDP-17的类型

部分上交给哪个处理过程, 1表示为 ICMP 协议, 2表示为 IGMP 协议, 6表示为
TCP 协议, 17表示为 UDP 协议
首部检验和:占16位,只检验数据报的首部不检验数据部分.这里不采用 CRC 检验
码而采用简单的计算方法
源地址和目的地址:都各占4字节,分别记录源地址和目的地址


-----------------------------------------------------------------------------------
-----------------------------------------------------------------------------------

传输层协议：之TCP协议、UDP协议。

    TCP/IP协议栈
        1.传输控制协议 -Transmission Control Protocol/Internet Protocol

        2.tcp/ip模型 对比OSI的七层模型
          tcp/ip的5层模型
          5.应用层
          4.传输层  TCP&UDP协议
          3.Internet层/网络层   -IP协议
          2.数据链路层
          1.物理层


TCP协议和UDP协议的区别：

    TCP:传输控制协议  UDP:用户数据报协议 
    相同：都是传输层协议
    不同：
        1.Connection Type方式不同：
          TCP-面向连接：通讯双方在利用某个协议前，要先通过发送报文测试，确认网络是正常连接的.
          UDP-非面向连接：只负责发送报文，而不确认网络是否连接
        2.Sequencing:序列化不同
          TCP：每个数据在用tcp传输的时候，每个是数据报文是有编号的 -数据报文按照编号进行组合可以保证数据的正确性
          UDP：无次序，根据接收端接收到每个数据报文的时间确定先后顺序 -所以组合起来的数据报文可能是错的
        3.使用场景不同：
          TCP:用于文件下载,邮件传输等
          UDP：视音频等


TCP特性

    TCP/IP协议工作原理：
       a.发送端进行封装、接收端进行解封装、
          层层封装：数据+应用层报头+TCP/UDP报头+IP报头+帧头部=物理层的0101
       b.解封装的过程：
          下层协议为上层协议提供服务：因为上层有各种协议，所以在向上传递时，会有标记来体现出上层协议的类型
          层层解封装：物理层的0101=帧头部+IP报头+TCP/UDP报头++应用层报头+数据

TCP包头 -固定长度20字节

TCP的固定首部包括：

     0                                       |                              31 共32位4个字节
  
 4        Source源端口(16bit)                       Destination目标端口(16bit)
 
 4                            序列号Sequence Number(32bit)

 4                          确认号Acknowledgement Number(32bit)

 4  headlength|保留|URG|ACK|PSH|RST|SYN|FIN|  |         窗口大小windows size(16bit)
    也叫数据偏移
 
 4        TCP Checksum检验和(16bit)                Urgent Pointer紧急指针(16bit)
 
 4                                 Optinons选项位-长度可变   | 填充


    1.端口号：下层协议为上层协议提供服务，传输层上层为应用层
        传输层传给给应用层时，由于应用层协议有多种，所以通过端口号来标识传给哪一种应用层协议，即应用程序的唯一标识
        端口号有16位，理论上有2^16=65536 0-65535个端口号

   如： /etc/services 记录系统中服务使用的端口号
        服务端端口号：
        0-1023:系统端口号-仅管理员可用
        http:tcp80  https:tcp443 ssh：tcp22 ftp：21 telnet:23 dhcp:67,68 kerberos:88-加密服务
        snmp:161    mysql:tcp3306 oracle:1521 sqlserver:1433 SMTP：25 pop:110 imap:143 vnc:5900
        客户端端口号：随机分配
        /proc/sys/net/ipv4/ip_local_port_range 可以通过修改配置文件，分配更少或更多的端口号 -如代理服务器

    2.序列号seq=Sequence Number(32bit)
       tcp协议具有序列性：
       用来标识从TCP源端向目的端发送的字节流，发起方发送数据时对此进行标记
       tcp协议会把数据切割成一个个段(segent),接收端根据序列号组合成完整数据 最多2^32段

    3.确认号ack=Acknowledgement Number(32bit)      
       -区别于ACK标志位
       tcp协议具有序列性和双向性：
       发送端发过来的包接收端收到后，会回复一个确认号来表示已收到,只有ACK标志位为1时，确认序号字段才有效，Ack=Seq+1。
     注意：发送端和接收端都有各自的序列号和确认号
           即在三次握手时，会发送各自的sn号和an号，在下面三次握手具体体现

    4.6个标志位: -非1即0
      重要的标志位：ACK SYN FIN 
      需要注意的是：
                    （A）不要将确认序号Ack与标志位中的ACK搞混了。
                    （B）确认方Ack=发起方Req+1，两端配对。 

  ACK：确认序号有效;
       表示是否前面确认号字段是否有效。只有当ACK=1时，前面的确认号字段才有效。TCP规定，连接建立后，ACK必须为1,带ACK标志的TCP报文段称为确认报文段
  
  SYN：发起一个新连接;
       在建立连接时使用，用来同步序号。当SYN=1，ACK=0时，表示这是一个请求建立连接的报文段；当SYN=1，ACK=1时，表示对方同意建立连接。SYN=1，说明这是一个请求
       建立连接或同意建立连接的报文。只有在前两次握手中SYN才置为1，带SYN标志的TCP报文段称为同步报文段
  
  FIN：释放一个连接;
       表示通知对方本端要关闭连接了，标记数据是否发送完毕。如果FIN=1，即告诉对方：“我的数据已经发送完毕，你可以释放连接了”，带FIN标志的TCP报文段称为结束报文段
  
  URG：紧急指针（urgent pointer）有效;
      表示本报文段中发送的数据是否包含紧急数据。后面的紧急指针字段（urgentp ointer）只有当URG=1时才有效
  
  PSH：接收方应该尽快将这个报文交给应用层;
       提示接收端应用程序应该立即从TCP接收缓冲区中读走数据，为接收后续数据腾出空间。
       如果为1，则表示对方应当立即把数据提交给上层应用，而不是缓存起来，如果应用程序不将接收到的数据读走，就会一直停留在TCP接收缓冲区中
  
  RST：重置连接;
       如果收到一个RST=1的报文，说明与主机的连接出现了严重错误（如主机崩溃），必须释放连接，然后再重新建立连接。
       或者说明上次发送给主机的数据有问题，主机拒绝响应，带RST标志的TCP报文段称为复位报文段
 
 5.TCP的最大报文长度 1500-tcp头部-IP头部=1460
   最大报文段长度MSS;
   MTU和MSS的关系： MTU=MSS+IP Header+TCP Header
   通信双方最终的MSS值=较小MTU-IP Header-TCP Header


